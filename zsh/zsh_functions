# remove all images matching the patterns
dockerrmi() {
	if ! command -v docker >/dev/null; then
		echo "docker not found"
		return 1
	fi

	if (($# == 0)); then
		echo "Usage: dockerrmi <pattern1> <pattern2> or dockerrmi <pattern1,pattern2,...>"
		return 1
	fi

	local patterns_array=()
	for arg in "$@"; do
		patterns_array+=("${arg//,/|}")
	done

	local final_pattern
	IFS='|' final_pattern="${patterns_array[*]}"

	docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' \
		| grep -iE "$final_pattern" \
		| cut -d' ' -f2 \
		| xargs -r docker rmi -f
}

# create and switch to a new tmux session from the current directory
# works inside tmux sessions
tns() {
        local session_name="$1"
        [ -z "$session_name" ] && {
                echo "Usage: tns <session_name>"
                        return 1
                }

        if [ -z "$TMUX" ]; then
                tmux new -s "$session_name"
                return 1
        fi

        if ! tmux has-session -t "$session_name" 2>/dev/null; then
                tmux new-session -d -s "$session_name" -c "$PWD"
        fi
        tmux switch-client -t "$session_name"
}

# kill all processes on the specified ports
killports() {
	if (($# == 0)); then
		echo "Usage: killports <pattern1> <pattern2> or killports <pattern1,pattern2,...>"
		return 1
	fi
	local ports=$(IFS=,; echo "$*")
	echo "Killing ports $ports"
	sudo kill -9 $(sudo lsof -ti :$ports)
}

# fuzzy search and checkout git local/remote branches
gb() {
	local force=$1
	local selected=$(git branch -va | fzf-tmux | awk '{print $1}')
	[[ -z "$selected" ]] && return 1

	[[ $force != "-f" && $force != "--force" ]] && force=""

	if [[ $selected == remotes/* ]]; then
		local remote_branch=${selected#remotes/}
		local local_branch=${remote_branch#*/}

		if git show-ref --verify --quiet "refs/heads/$local_branch"; then
			git checkout $force "$local_branch"
		else
			git checkout -t $force "$remote_branch"
		fi
	else
		git checkout $force "$selected"
	fi
}

# ask ai (opencode shell agent) for a command, then populate buffer for review
# example usage:
# ai count the total lines of code in all Golang files in this repo
ai() {
	print -z "$(opencode run --agent=shell "$*")"
}
